- en: Leveraging Compiler Optimization Flags in Go
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 在 Go 中利用编译器优化标志
- en: 原文：[https://goperf.dev/01-common-patterns/comp-flags/](https://goperf.dev/01-common-patterns/comp-flags/)
  id: totrans-1
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
  zh: '[https://goperf.dev/01-common-patterns/comp-flags/](https://goperf.dev/01-common-patterns/comp-flags/)'
- en: 'When tuning Go applications for performance, most of the attention goes to
    runtime behavior—profiling hot paths, trimming allocations, improving concurrency.
    But there’s another layer that’s easy to miss: what the Go compiler does with
    your code before it ever runs. The build process includes several optimization
    passes, and understanding how to surface or influence them can give you clearer
    insights into what’s actually happening under the hood. It’s not about tweaking
    obscure flags to squeeze out extra instructions—it’s about knowing how the compiler
    treats your code so you’re not working against it.'
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 当调整 Go 应用程序以获得性能时，大部分注意力都集中在运行时行为上——分析热点路径、减少分配、提高并发性。但还有一个容易被忽视的层面：Go 编译器在代码运行之前对代码做了什么。构建过程包括几个优化步骤，了解如何揭示或影响它们可以让你更清楚地了解底层实际发生了什么。这并不是关于调整晦涩的标志来挤出额外指令——这是关于了解编译器如何处理你的代码，这样你就不会与之作对。
- en: While Go doesn’t expose the same granular set of compiler flags as C or Rust,
    it still provides useful ways to influence how your code is built—especially when
    targeting performance, binary size, or specific environments.
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: 虽然 Go 没有像 C 或 Rust 那样提供相同粒度的编译器标志，但它仍然提供了有用的方法来影响代码的构建方式——特别是在针对性能、二进制大小或特定环境时。
- en: Why Compiler Flags Matter
  id: totrans-4
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 为什么编译器标志很重要
- en: 'Go''s compiler (specifically `cmd/compile` and `cmd/link`) performs several
    default optimizations: inlining, escape analysis, dead code elimination, and more.
    However, there are scenarios where you can squeeze more performance or control
    from your build using the right flags.'
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
  zh: Go 的编译器（特别是 `cmd/compile` 和 `cmd/link`）执行了几个默认优化：内联、逃逸分析、死代码消除等。然而，在某些情况下，你可以使用正确的标志从构建中获得更多的性能或控制。
- en: 'Use cases include:'
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: 用例包括：
- en: Reducing binary size for minimal containers or embedded systems
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 为最小容器或嵌入式系统减少二进制文件大小
- en: Building for specific architectures or OSes
  id: totrans-8
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 为特定架构或操作系统构建
- en: Removing debug information for release builds
  id: totrans-9
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 删除发布构建中的调试信息
- en: Disabling optimizations temporarily for easier debugging
  id: totrans-10
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 临时禁用优化以简化调试
- en: Enabling experimental or unsafe performance tricks (carefully)
  id: totrans-11
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 启用实验性或非安全性能技巧（谨慎使用）
- en: Key Compiler and Linker Flags
  id: totrans-12
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 关键编译器和链接器标志
- en: '`-ldflags="-s -w"` — Strip Debug Info'
  id: totrans-13
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: '`-ldflags="-s -w"` — 删除调试信息'
- en: 'When you want to shrink binary size, especially in production or containers:'
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 当你想要缩小二进制文件大小时，尤其是在生产或容器中：
- en: '[PRE0]'
  id: totrans-15
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: '`-s`: Omit the symbol table'
  id: totrans-16
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`-s`: 省略符号表'
- en: '`-w`: Omit DWARF debugging information'
  id: totrans-17
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`-w`: 省略 DWARF 调试信息'
- en: 'Why it matters: This can reduce binary size by up to 30-40%, depending on your
    codebase. It is useful in Docker images or when distributing binaries.'
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: 为什么这很重要：这可以将二进制文件大小减少 30-40%，具体取决于你的代码库。这在 Docker 镜像或分发二进制文件时很有用。
- en: '`-gcflags` — Control Compiler Optimizations'
  id: totrans-19
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: '`-gcflags` — 控制编译器优化'
- en: 'The `-gcflags` flag allows you to control how the compiler treats specific
    packages. For example, you can disable optimizations for debugging:'
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: '`-gcflags` 标志允许你控制编译器如何处理特定的包。例如，你可以禁用调试时的优化：'
- en: '[PRE1]'
  id: totrans-21
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: '`-N`: Disable optimizations'
  id: totrans-22
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`-N`: 禁用优化'
- en: '`-l`: Disable inlining'
  id: totrans-23
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`-l`: 禁用内联'
- en: 'When to use: During debugging sessions with Delve or similar tools. Turning
    off inlining and optimizations make stack traces and breakpoints more reliable.'
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: 何时使用：在 Delve 或类似工具的调试会话期间。关闭内联和优化可以使堆栈跟踪和断点更可靠。
- en: Cross-Compilation Flags
  id: totrans-25
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 跨编译器标志
- en: Need to build for another OS or architecture?
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: 需要为另一个操作系统或架构构建？
- en: '[PRE2]'
  id: totrans-27
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: '`GOOS`, `GOARCH`: Set target OS and architecture'
  id: totrans-28
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`GOOS`, `GOARCH`: 设置目标操作系统和架构'
- en: 'Common values: `windows`, `darwin`, `linux`, `amd64`, `arm64`, `386`, `wasm`'
  id: totrans-29
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 常见值：`windows`, `darwin`, `linux`, `amd64`, `arm64`, `386`, `wasm`
- en: Build Tags
  id: totrans-30
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 构建标签
- en: Build tags allow conditional compilation. Use `//go:build` or `// +build` in
    your source code to control what gets compiled in.
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: 构建标签允许条件编译。在你的源代码中使用 `//go:build` 或 `// +build` 来控制编译的内容。
- en: 'Example:'
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: 示例：
- en: '[PRE3]'
  id: totrans-33
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: 'Then build with:'
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: 然后使用以下命令进行构建：
- en: '[PRE4]'
  id: totrans-35
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: '`-ldflags="-X ..."` — Inject Build-Time Variables'
  id: totrans-36
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: '`-ldflags="-X ..."` — 注入构建时变量'
- en: 'You can inject version numbers or metadata into your binary at build time:'
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以在构建时将版本号或元数据注入到你的二进制文件中：
- en: '[PRE5]'
  id: totrans-38
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: 'Then build with:'
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: 然后使用以下命令进行构建：
- en: '[PRE6]'
  id: totrans-40
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: This sets the `version` variable at link time without modifying your source
    code. It's useful for embedding release versions, commit hashes, or build dates.
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: 这在链接时设置 `version` 变量，而不修改你的源代码。这对于嵌入发布版本、提交哈希或构建日期很有用。
- en: '`-extldflags=''-static''` — Build Fully Static Binaries'
  id: totrans-42
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: '`-extldflags=''-static''` — 构建完全静态的二进制文件'
- en: The `-extldflags '-static'` option passes the `-static` flag to the external
    system linker, instructing it to produce a **fully statically linked binary**.
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: '`-extldflags ''-static''` 选项将 `-static` 标志传递给外部系统链接器，指示它生成一个**完全静态链接的二进制文件**。'
- en: 'This is especially useful when you''re using CGO and want to avoid runtime
    dynamic library dependencies:'
  id: totrans-44
  prefs: []
  type: TYPE_NORMAL
  zh: 这在您使用 CGO 并希望避免运行时动态库依赖时特别有用：
- en: '[PRE7]'
  id: totrans-45
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: 'What it does:'
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: 它的作用：
- en: Statically links all C libraries into the binary
  id: totrans-47
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 将所有 C 库静态链接到二进制文件中
- en: Produces a portable, self-contained executable
  id: totrans-48
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 生成一个便携式、自包含的可执行文件
- en: Ideal for minimal containers (like `scratch` or `distroless`)
  id: totrans-49
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 适用于最小化容器（如 `scratch` 或 `distroless`）
- en: 'To go further and ensure your binary avoids relying on C library DNS resolution
    (such as `glibc`''s `getaddrinfo`), you can use the `netgo` build tag. This forces
    Go to use its pure Go implementation of the DNS resolver:'
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
  zh: 要进一步确保你的二进制文件不依赖于 C 库的 DNS 解析（例如 `glibc` 的 `getaddrinfo`），你可以使用 `netgo` 构建标签。这强制
    Go 使用其纯 Go 实现的 DNS 解析器：
- en: '[PRE8]'
  id: totrans-51
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: This step is especially important when building for minimal container environments,
    where dynamic libc dependencies may not be available.
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: 在构建最小化容器环境时，这一步尤其重要，因为在这些环境中可能不可用动态 libc 依赖。
- en: Note
  id: totrans-53
  prefs: []
  type: TYPE_NORMAL
  zh: 注意
- en: Static linking requires static versions (`.a`) of the libraries you're using,
    and may not work with all C libraries by default.
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: 静态链接需要使用你使用的库的静态版本（`.a`），并且默认情况下可能不适用于所有 C 库。
- en: 'Example: Static Build with libcurl via CGO'
  id: totrans-55
  prefs:
  - PREF_H4
  type: TYPE_NORMAL
  zh: 示例：通过 CGO 使用 libcurl 进行静态构建
- en: 'If you’re using libcurl via CGO, here’s how you can create a statically linked
    Go binary:'
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你正在通过 CGO 使用 libcurl，以下是创建静态链接的 Go 二进制文件的方法：
- en: '[PRE9]'
  id: totrans-57
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: 'Static Build Command:'
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: 静态构建命令：
- en: '[PRE10]'
  id: totrans-59
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: Ensure the static version of libcurl (`libcurl.a`) is available on your system.
    You may need to install development packages or build libcurl from source with
    `--enable-static`.
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: 确保系统上可用的 libcurl 的静态版本（`libcurl.a`）。你可能需要安装开发包或使用 `--enable-static` 从源代码构建 libcurl。
